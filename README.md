An exercise in state machines
